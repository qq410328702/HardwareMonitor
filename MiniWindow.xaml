<Window x:Class="HardwareMonitor.MiniWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:HardwareMonitor.Converters"
        Title="Monitor" Width="320" Height="210"
        WindowStyle="None" AllowsTransparency="True"
        Topmost="True" ShowInTaskbar="False"
        ResizeMode="NoResize" Background="Transparent">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:FloatFormatConverter x:Key="FloatFmt"/>
        <conv:RatioToWidthConverter x:Key="RatioToWidth"/>
    </Window.Resources>

    <Border CornerRadius="16" BorderThickness="2"
            Background="{DynamicResource MiniBgBrush}">
        <Border.Style>
            <Style TargetType="Border">
                <Setter Property="BorderBrush" Value="{DynamicResource MiniBorderBrush}"/>
                <Style.Triggers>
                    <DataTrigger Binding="{Binding IsError}" Value="True">
                        <Setter Property="BorderBrush" Value="#F85149"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <Border.Effect>
            <DropShadowEffect BlurRadius="24" ShadowDepth="2" Opacity="0.4" Color="Black"/>
        </Border.Effect>

        <Grid>
            <Border Background="Transparent"
                    MouseLeftButtonDown="DragArea_MouseDown"
                    MouseRightButtonDown="DragArea_MouseRightDown"
                    Panel.ZIndex="0"/>

            <Grid Margin="16,12" Panel.ZIndex="1" IsHitTestVisible="False">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="6"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="6"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Orientation="Horizontal">
                    <Ellipse Width="8" Height="8" Margin="0,0,8,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="{DynamicResource AccentGreenBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsError}" Value="True">
                                        <Setter Property="Fill" Value="#F85149"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="Hardware Monitor" FontSize="12" FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}" Opacity="0.7"/>
                </StackPanel>

                <!-- CPU / GPU -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="6"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- CPU -->
                    <Border Grid.Column="0" CornerRadius="10" Padding="12,8"
                            Background="{DynamicResource MiniCardBrush}">
                        <StackPanel>
                            <TextBlock Text="CPU" FontSize="10" Foreground="{DynamicResource AccentBlueBrush}"
                                       FontWeight="Bold" Margin="0,0,0,3"/>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontSize="22" FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           Text="{Binding CpuTemp, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"/>
                                <TextBlock Text="°" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Top" Margin="1,2,0,0"/>
                                <TextBlock FontSize="22" FontWeight="Bold"
                                           Foreground="{DynamicResource AccentBlueBrush}"
                                           Text="{Binding CpuUsage, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"
                                           Margin="8,0,0,0"/>
                                <TextBlock Text="%" FontSize="11" Foreground="{DynamicResource AccentBlueBrush}"
                                           VerticalAlignment="Bottom" Margin="1,0,0,4"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                <TextBlock Text="⚡" FontSize="10" Margin="0,0,3,0"/>
                                <TextBlock FontSize="11" FontWeight="SemiBold"
                                           Foreground="{DynamicResource AccentOrangeBrush}"
                                           Text="{Binding CpuPower, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"/>
                                <TextBlock Text="W" FontSize="9" Foreground="{DynamicResource AccentOrangeBrush}"
                                           VerticalAlignment="Bottom" Margin="2,0,0,2"/>
                            </StackPanel>
                            <Grid Height="3" Margin="0,4,0,0" x:Name="CpuBarContainer">
                                <Border Background="{DynamicResource MiniBarBgBrush}" CornerRadius="2"/>
                                <Border Background="{DynamicResource AccentBlueBrush}" CornerRadius="2"
                                        HorizontalAlignment="Left">
                                    <Border.Width>
                                        <MultiBinding Converter="{StaticResource RatioToWidth}">
                                            <Binding Path="CpuUsage"/>
                                            <Binding Path="ActualWidth" ElementName="CpuBarContainer"/>
                                        </MultiBinding>
                                    </Border.Width>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- GPU -->
                    <Border Grid.Column="2" CornerRadius="10" Padding="12,8"
                            Background="{DynamicResource MiniCardBrush}">
                        <StackPanel>
                            <TextBlock Text="GPU" FontSize="10" Foreground="{DynamicResource AccentGreenBrush}"
                                       FontWeight="Bold" Margin="0,0,0,3"/>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontSize="22" FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           Text="{Binding GpuTemp, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"/>
                                <TextBlock Text="°" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Top" Margin="1,2,0,0"/>
                                <TextBlock FontSize="22" FontWeight="Bold"
                                           Foreground="{DynamicResource AccentGreenBrush}"
                                           Text="{Binding GpuUsage, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"
                                           Margin="8,0,0,0"/>
                                <TextBlock Text="%" FontSize="11" Foreground="{DynamicResource AccentGreenBrush}"
                                           VerticalAlignment="Bottom" Margin="1,0,0,4"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                <TextBlock Text="⚡" FontSize="10" Margin="0,0,3,0"/>
                                <TextBlock FontSize="11" FontWeight="SemiBold"
                                           Foreground="{DynamicResource AccentOrangeBrush}"
                                           Text="{Binding GpuPower, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"/>
                                <TextBlock Text="W" FontSize="9" Foreground="{DynamicResource AccentOrangeBrush}"
                                           VerticalAlignment="Bottom" Margin="2,0,0,2"/>
                            </StackPanel>
                            <Grid Height="3" Margin="0,4,0,0" x:Name="GpuBarContainer">
                                <Border Background="{DynamicResource MiniBarBgBrush}" CornerRadius="2"/>
                                <Border Background="{DynamicResource AccentGreenBrush}" CornerRadius="2"
                                        HorizontalAlignment="Left">
                                    <Border.Width>
                                        <MultiBinding Converter="{StaticResource RatioToWidth}">
                                            <Binding Path="GpuUsage"/>
                                            <Binding Path="ActualWidth" ElementName="GpuBarContainer"/>
                                        </MultiBinding>
                                    </Border.Width>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- RAM + Total Power -->
                <Grid Grid.Row="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="6"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="0" CornerRadius="10" Padding="12,7"
                            Background="{DynamicResource MiniCardBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="RAM" FontSize="10" Foreground="{DynamicResource AccentPurpleBrush}"
                                       FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <Grid Grid.Column="1" VerticalAlignment="Center" Height="3" x:Name="MemBarContainer">
                                <Border Background="{DynamicResource MiniBarBgBrush}" CornerRadius="2"/>
                                <Border Background="{DynamicResource AccentPurpleBrush}" CornerRadius="2"
                                        HorizontalAlignment="Left">
                                    <Border.Width>
                                        <MultiBinding Converter="{StaticResource RatioToWidth}">
                                            <Binding Path="MemUsage"/>
                                            <Binding Path="ActualWidth" ElementName="MemBarContainer"/>
                                        </MultiBinding>
                                    </Border.Width>
                                </Border>
                            </Grid>
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="10,0,0,0">
                                <TextBlock FontSize="14" FontWeight="Bold"
                                           Foreground="{DynamicResource AccentPurpleBrush}"
                                           Text="{Binding MemUsage, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"
                                           VerticalAlignment="Center"/>
                                <TextBlock Text="%" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Center" Margin="2,0,0,0"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <Border Grid.Column="2" CornerRadius="10" Padding="12,7"
                            Background="{DynamicResource MiniCardBrush}" MinWidth="70">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="总功耗" FontSize="9" Foreground="{DynamicResource AccentOrangeBrush}"
                                       FontWeight="Bold" HorizontalAlignment="Center"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,1,0,0">
                                <TextBlock Text="⚡" FontSize="11"/>
                                <TextBlock FontSize="15" FontWeight="Bold"
                                           Foreground="{DynamicResource AccentOrangeBrush}"
                                           Text="{Binding TotalPower, Converter={StaticResource FloatFmt}, ConverterParameter=F0}"/>
                                <TextBlock Text="W" FontSize="10" Foreground="{DynamicResource AccentOrangeBrush}"
                                           VerticalAlignment="Bottom" Margin="2,0,0,3"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>

                <TextBlock Grid.Row="6" Text="拖拽移动 · 右键关闭" FontSize="9"
                           Foreground="{DynamicResource MiniHintBrush}" HorizontalAlignment="Center"/>
            </Grid>

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top"
                        Margin="0,10,14,0" Panel.ZIndex="2">
                <Button Content="□" Click="Expand_Click" Style="{x:Null}"
                        Width="24" Height="22" FontSize="10" Cursor="Hand" ToolTip="展开主窗口"
                        Background="Transparent" Foreground="{DynamicResource TextSecondaryBrush}"
                        BorderThickness="0" IsHitTestVisible="True"/>
                <Button Content="✕" Click="Close_Click" Style="{x:Null}"
                        Width="24" Height="22" FontSize="11" Cursor="Hand"
                        Background="Transparent" Foreground="{DynamicResource TextSecondaryBrush}"
                        BorderThickness="0" IsHitTestVisible="True"/>
            </StackPanel>

            <!-- Error Overlay: Visible when IsError == true -->
            <Border Background="{DynamicResource MiniBgBrush}" CornerRadius="14"
                    Visibility="{Binding IsError, Converter={StaticResource BoolToVis}}"
                    Panel.ZIndex="1" Margin="1">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="16">
                    <TextBlock Text="⚠" FontSize="28" HorizontalAlignment="Center"
                               Foreground="#F85149" Margin="0,0,0,6"/>
                    <TextBlock Text="监控异常" FontSize="13" FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               HorizontalAlignment="Center" Margin="0,0,0,4"/>
                    <TextBlock Text="{Binding ErrorMessage}" FontSize="10"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" TextWrapping="Wrap"
                               TextAlignment="Center" MaxWidth="260"
                               TextTrimming="CharacterEllipsis" MaxHeight="36"/>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</Window>
